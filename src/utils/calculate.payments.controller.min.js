import query from"../controllers/query.controller";export async function calculatePayments(e,t,s){let r,n,c=await query("SELECT\n   assurances.percentage_coverage,\n   rstctd_medicines AS rstrct_medicines,\n   rstctd_tests AS rstrct_tests,\n   rstctd_operations AS rstrct_operations,\n   rstctd_services AS rstrct_services,\n   rstctd_equipments AS rstrct_equipments\n  FROM \n   assurances \n    LEFT JOIN medicines ON JSON_CONTAINS(assurances.rstctd_medicines, JSON_QUOTE(medicines.id), '$')\n    LEFT JOIN tests ON JSON_CONTAINS(assurances.rstctd_tests, JSON_QUOTE(tests.id), '$')\n    LEFT JOIN operations ON JSON_CONTAINS(assurances.rstctd_operations, JSON_QUOTE(operations.id), '$')\n    LEFT JOIN equipments ON JSON_CONTAINS(assurances.rstctd_equipments, JSON_QUOTE(equipments.id), '$')\n    LEFT JOIN services ON JSON_CONTAINS(assurances.rstctd_services, JSON_QUOTE(services.id), '$')\n  WHERE\n   assurances.id = ?\n   group by assurances.id\n    ",[e]),a=0;try{0==c.length||(a=1,c=c[0],c.rstrct_medicines=JSON.parse(c.rstrct_medicines),c.rstrct_tests=JSON.parse(c.rstrct_tests),c.rstrct_operations=JSON.parse(c.rstrct_operations),c.rstrct_services=JSON.parse(c.rstrct_services),c.rstrct_equipments=JSON.parse(c.rstrct_equipments),r={assurance:c.percentage_coverage,patient:100-c.percentage_coverage},n={medicines:c.rstrct_medicines,tests:c.rstrct_tests,operations:c.rstrct_operations,equipments:c.rstrct_medicines,services:c.rstrct_services});let e={assurance_amount:0,patient_amount:0};if(s){if(!a){for(const s of Object.keys(t))for(const r of t[s])r.servedOut||(e.patient_amount+=r.price);return e}for(const s of Object.keys(t))for(const c of t[s])if(n[s].length){if(!c.servedOut){let t=n[s].find(function(e){return e==c.id});console.log(t),t?e.patient_amount+=c.price:(e.assurance_amount+=Number(c.price)*Number(r.assurance)/100,e.patient_amount+=Number(c.price)*Number(r.patient)/100,e.assurance_amount=Number(e.assurance_amount.toFixed(2)),e.patient_amount=Number(e.patient_amount.toFixed(2)))}}else c.servedOut||(e.assurance_amount+=Number(c.price)*Number(r.assurance)/100,e.patient_amount+=Number(c.price)*Number(r.patient)/100,e.assurance_amount=Number(e.assurance_amount.toFixed(2)),e.patient_amount=Number(e.patient_amount.toFixed(2)),console.log(e));return e}}catch(e){return void console.log(e)}}