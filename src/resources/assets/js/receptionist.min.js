function genClicks(e){let t=sessiondata("messages");e.map(e=>{e.addEventListener("click",()=>{if(!e.classList.contains("list-link"))return 0;v=document.querySelector(`div#${e.getAttribute("data-href-target")}`);let n=t.find(function(t){return t.id==e.getAttribute("data-id")});if(v&&n){p=Array.from(v.parentElement.querySelectorAll(".pagecontentsection")),s=p.indexOf(v);let t=new URL(window.location.href);if("test_res_message"==e.getAttribute("data-message-type")||"session_message"==e.getAttribute("data-message-type")){let s;n.addins?s=n.addins.session:n.extra&&(s=n.extra.session),s&&(t.pathname=`/${getPath()[0]}/${e.getAttribute("data-href-target")}/${s}`)}window.history.pushState({},"",t.toString()),cpgcntn(p.indexOf(v),p),gsd(v,null)}})})}let q,w,e,r,t,y,u,i,o,p,a,s,d,f,g,h,j,k,l,z,x,c,v,b,n,m,notificationlinks;import{alertMessage,getdata,getschema,postschema,request,initializeCleave,checkEmpty,cpgcntn,showRecs,getchips,getPath,showAvaiEmps,deletechild,geturl,addsCard,showAvaiAssurances,addLoadingTab,RemoveAuthDivs,showFingerprintDiv,sessiondata}from"../../../utils/functions.controller.js";import{pushNotifs,userinfo,expirateMssg,getNfPanelLinks,m as messages}from"./nav.js";import{addUprofile,uprofileStf}from"../../../utils/user.profile.controller.js";(async function(){async function e(e){if(x=e.id,"search-patient"==x){if(f=e.querySelector('form[name="sp-form"]'),s=f.querySelector('input[type="text"]'),setTimeout(e=>{s.focus()},200),b=f.querySelector('button[type="submit"]'),getPath(2)){if(b.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>',b.setAttribute("disabled",!0),r=await request(`patient/${getPath(2)}`,postschema),s.value=getPath(2),b.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',b.removeAttribute("disabled"),!r.success)return alertMessage(r.message);uprofileStf(r,d)}let t=e.querySelector("span#fingerprint");t.onclick=async function(){let e=await showFingerprintDiv("search");if(e){if(postschema.body=JSON.stringify({token:getdata("token"),fp_data:e,type:"fp"}),r=await request("patient/",postschema),RemoveAuthDivs(),!r.success)return alertMessage(r.message);uprofileStf(r,d);let t=new URL(window.location.href);t.pathname=`/receptionist/search-patient/${r.message.id}`,window.history.pushState({},"",t.toString())}},f.onsubmit=(async e=>{if(e.preventDefault(),!s.value)return 0;if(b.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>',b.setAttribute("disabled",!0),r=await request(`patient/${s.value}`,postschema),b.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',b.removeAttribute("disabled"),!r.success)return alertMessage(r.message);let t=new URL(window.location.href);t.pathname=`/${getPath()[0]}/search-patient/${s.value}`,window.history.pushState({},"",t.toString()),uprofileStf(r,d)})}else if("my-account"==x){n=document.querySelector("span.name"),n.textContent=userinfo.message.Full_name,i=document.querySelector("span.n-img"),i.textContent=userinfo.message.Full_name.substring(0,1);let t=Array.from(e.querySelectorAll("span.icon-edit-icon"));for(const e of t)e.addEventListener("click",()=>{l=e.getAttribute("data-target"),shedtpopup(l,r)})}else if("register-patient"==x){try{f=document.querySelector("form#add-patient-form");let e,n=f.querySelector("button#add-fp"),a=f.querySelector("span#fp_ind");s=Array.from(f.querySelectorAll("select.address-field")),g=Array.from(f.querySelectorAll("select.form-select")),i=Array.from(f.querySelectorAll("input"));let r=i.find(function(e){return"householder"==e.name}),c=i.filter(function(e){return"radio"==e.type});for(const e of c)e.addEventListener("mousedown",t=>{"patient"==e.value?(r.parentElement.classList.replace("hidden","block"),r.classList.toggle("optional")):(r.parentElement.classList.replace("block","hidden"),r.value=null,r.classList.toggle("optional"))});initializeCleave(f.querySelector("input.phone-number-mask"),f.querySelector("input.national-id-no-mask")),initializeCleave(null,r);for(const e of s)i.push(e);for(const e of g)i.push(e);b=f.querySelector('button[type="submit"]');for(let e of m)e=e.provinces[0],o=document.createElement("option"),s[0].appendChild(o),o.innerText=e.name,o.value=e.id,o.setAttribute("data-id",e.id);let l=f.querySelector("input#assurances");l.addEventListener("focus",function(e){showRecs(this,q.message,"assurances")});for(const e of s)e.addEventListener("change",n=>{if(n.preventDefault(),"province"==e.name)for(let n of m)n=n.provinces[0],n.id==e.value?(s[2].innerHTML='<option value="">Choose...</option>',s[3].innerHTML='<option value="">Choose...</option>',t(n.districts,s[1],"district")):""==e.value&&(s[1].innerHTML='<option value="">Choose...</option>',s[2].innerHTML='<option value="">Choose...</option>',s[3].innerHTML='<option value="">Choose...</option>');if("district"==e.name)for(let n of m){n=n.provinces[0];for(const o of n.districts)o.id==e.value?(s[3].innerHTML='<option value="">Choose...</option>',t(o.sectors,s[2],"sector")):""==e.value&&(s[2].innerHTML='<option value="">Choose...</option>',s[3].innerHTML='<option value="">Choose...</option>')}if("sector"==e.name)for(let n of m){n=n.provinces[0];for(const o of n.districts)for(const n of o.sectors)n.id==e.value?t(n.cells,s[3],"cell"):""==e.value&&(s[3].innerHTML='<option value="">Choose...</option>')}});n.onclick=async function(t){t.preventDefault(),e=await showFingerprintDiv("register"),e&&(RemoveAuthDivs(),a.classList.replace("bc-gray","bc-tr-green"),a.classList.replace("dgray","green"),a.classList.remove("mt--2p"),a.innerHTML='<i class="fas fa-check"></i>')},f.addEventListener("submit",async t=>{let s,n,o,a,r;o="",a="",n={},v=1,t.preventDefault();for(const e of i)if(s=checkEmpty(e),s||(v=0),"phone"==e.name||"nid"==e.name||"householder"==e.name)Object.assign(n,{[e.name]:"phone"==e.name&&"+250"==e.value?null:e.value.replace(/ /g,"")});else if("firstname"==e.name)a+=`${e.value+Math.floor(999*Math.random()).toString().padStart(3,"0")}.`,o+=`${e.value} `;else if("lastname"==e.name)a+=`${e.value+Math.floor(999*Math.random()).toString().padStart(3,"0")}`,o+=`${e.value}`;else if(e.classList.contains("chips-check")){if(z=checkEmpty(e),z)if("assurances"==e.name){q=[];for(const t of getchips(e.parentNode.querySelector("div.chipsholder"),["id","number"]))Object.assign(t,{status:"eligible"}),q.push(t);Object.assign(n,{[e.name]:q})}else Object.assign(n,{[e.name]:getchips(e.parentNode.querySelector("div.chipsholder"))})}else Object.assign(n,{[e.name]:e.value});for(const e of c)e.checked&&Object.assign(n,{role:e.value});v&&(Object.assign(n,{Full_name:o,username:a,fp_data:e}),postschema.body=JSON.stringify(n),console.log(n),r=await request("api/signup",postschema),alertMessage(r.message),r.success&&(localStorage.setItem("userid",n.username),window.location.href="../auth"))})}catch(e){console.log(e)}function t(e,t,s){t.innerHTML='<option value="">Choose...</option>';for(const s of e)o=document.createElement("option"),o.innerText=s.name,o.value=s.id,o.setAttribute("data-id",s.id),t.appendChild(o)}}}z=userinfo,m=await request("get-map",getschema),q=await request("get-assurances",getschema);let u=getdata("token");if(u||(window.location.href="../../login/"),!z.success)return localStorage.removeItem("token"),alertMessage(z.message);if(z.success){z=z.message,m=m.message;try{const e=io(geturl(),{query:{id:z.id}});e.on("connect",()=>{console.log("Connected to the server")}),e.on("message",e=>{pushNotifs(e),messages.push(e),notificationlinks=getNfPanelLinks(),genClicks(notificationlinks),addsCard(e.title,!0)}),e.on("expiratemssg",e=>{expirateMssg(e)}),e.on("selecthp",t=>{var s=document.createElement("div");document.body.appendChild(s);for(const e of t)s.innerHTML+=`<div id="${e.id}" class="verdana hover p-5p">${e.name}</div>`;let n=s.querySelectorAll("div");n.forEach(t=>{t.addEventListener("click",s=>{s.preventDefault(),e.emit("hpchoosen",{hp:t.id,token:localStorage.getItem("token")})})})}),e.on("changetoken",e=>{window.alert("token changed"),localStorage.setItem("token",e),window.location.href=window.location.href}),e.emit("messageToId",{recipientId:z.id,message:"wassup"}),"string"!=typeof z.hospital&&"object"==typeof z.hospital&&z.hospital.length>0&&e.emit("getpsforselection",z.hospital)}catch(e){console.log(e)}}postschema.body=JSON.stringify({token:localStorage.getItem("token")});let d=await request("get-hp-employees",postschema);if(!d)return alertMessage(d.message);d=d.message,a=getPath(1),c=Array.from(document.querySelectorAll("span.cpcards")),p=Array.from(document.querySelectorAll("div.pagecontentsection")),a?p.forEach(s=>{if(a==s.id)return t=p.indexOf(s),c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),c[t].classList.add("active","bb-1-s-theme","bc-tr-theme","theme"),cpgcntn(t,p),e(s),0}):(window.history.pushState("","","./home"),cpgcntn(0)),window.onpopstate=function(){a=getPath(1),a?p.forEach(e=>{if(a==e.id)return t=p.indexOf(e),c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),c[t].classList.add("active","bb-1-s-theme","bc-tr-theme","theme"),cpgcntn(t,p),0}):(window.history.pushState("","","./home"),cpgcntn(0,p))},c.forEach(t=>{t.addEventListener("click",()=>{c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),t.classList.add("active","bb-1-s-theme","bc-tr-theme","theme");let s=new URL(window.location.href);s.pathname=`/receptionist/${t.getAttribute("data-item-type")}`,window.history.pushState({},"",s.toString()),cpgcntn(c.indexOf(t),p),e(p.find(function(e){return e.id==t.getAttribute("data-item-type")}))})})})();