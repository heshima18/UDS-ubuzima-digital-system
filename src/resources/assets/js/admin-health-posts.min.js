import{alertMessage,getdata,getschema,postschema,request,initializeCleave,checkEmpty,showRecs,getchips,addshade,addLoadingTab,removeLoadingTab,aDePh,deletechild}from"../../../utils/functions.controller.js";let q,w,e,r,t,y,u,i,o,p,a,s,d,f,g,h,j,k,l,z,x,c,v,b,n,m;(async function(){function t(e,t,a){t.innerHTML=`<option value="">Select ${a}</option>`;for(const a of e)o=document.createElement("option"),o.innerText=a.name,o.value=a.id,o.setAttribute("data-id",a.id),t.appendChild(o)}async function l(e){let t=addshade(),a=document.createElement("div");t.appendChild(a),a.className="br-10p cntr card p-20p bsbb w-90 h-90 b-mgc-resp",a.innerHTML=`<div class="w-100 h-100 p-5p bp-0-resp">\n                            <div class="p-5p bsbb w-100 h-91 ovh p-r">\n                            <div class="head w-100 px-5p py-10p bsbb">\n                                <span class="capitalize bold-2"><span class="fs-25p" name="info-hol" data-hold="name">${e}</span></span>\n                            </div>\n                                <div class="w-100 h-100 ovys scroll-2 body">\n                                    <div class="head w-100 px-5p py-10p bsbb">\n                                        <span class="location dgray bold-2 capitalize">Location:</span>\n                                        <div class="flex">\n                                            <span class="capitalize px-5p" name="info-hol" data-hold="location.province"></span>,\n                                            <span class="capitalize px-5p" name="info-hol" data-hold="location.district"></span>,\n                                            <span class="capitalize px-5p" name="info-hol" data-hold="location.sector"></span>,\n                                            <span class="capitalize px-5p" name="info-hol" data-hold="location.cell"></span>\n                                        </div>\n                                        <span class="type dgray bold-2 capitalize">type:</span>\n                                        <div class="flex">\n                                            <span class="capitalize px-5p" name="info-hol" data-hold="type"></span>\n                                        </div>\n                                    </div>\n                                    <div class="departmentinfo my-5p">\n                                        <div class="flex jc-sb my-20p bsbb">\n                                            <span class="title bold-2 fs-16p capitalize center">employees</span>\n                                            <div class="p-10p my-5p mx-4p bsbb flex jc-sb">\n                                                <span class="btn-primary btn capitalize data-buttons btn-sm" data-role="add-employee" id="add-employee">add employee</span>\n                                            </div>\n                                        </div>\n                                        <div class="my-2p px-1p">\n                                            <ul class="card  ls-none my-10p iblock p-20p mx-5p my-5p bfull-resp bm-y-10p-resp bm-x-0-resp bblock-resp w-200p bfull-resp" name="looping-info" data-hold="employees">\n                                                <div class="x">\n                                                    <h5 class="card-title capitalize" name="looping-info-hol" data-hold="name" data-secondary-holder="true">[employee's-name]</h5>\n                                                    <p class="card-text" name="looping-info-hol" data-hold="title" data-secondary-holder="true">employee's-title</p>\n                                                    <p class="card-text"><small class="btn btn-sm btn-label-danger data-buttons" data-role="remove-employee" id="remove-employee">remove</small></p>\n                                                </div>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    <div class="departmentinfo my-5p">\n                                        <div class="flex jc-sb my-20p bsbb">\n                                            <span class="title bold-2 fs-16p capitalize center">Departments</span>\n                                            <div class="p-10p my-5p mx-4p bsbb flex jc-sb">\n                                                <span class="btn-primary btn capitalize data-buttons btn-sm" data-role="add-department">add a department</span>\n                                            </div>\n                                        </div>\n                                        <div class="my-2p px-1p">\n                                            <ul class="card  ls-none my-10p iblock p-20p mx-5p my-5p bfull-resp bm-y-10p-resp bm-x-0-resp bblock-resp w-200p bfull-resp" name="looping-info" data-hold="departments">\n                                                <li class="p-2p bsbb flex">\n                                                    <span class="bold-2 dgray card-title" name="looping-info-hol" data-hold="name" data-secondary-holder="true">[department's-name]</span>\n                                                </li>\n                                                <li class="p-2p bsbb ">\n                                                    <p class="mt-10p"><small class="btn btn-sm btn-label-danger data-buttons" data-role="remove-department" id="remove-department">remove</small></p>\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>`;let s=a.querySelector("div.body");if(addLoadingTab(s),postschema.body=JSON.stringify({token:getdata("token")}),e=await request(`hospital/${e}`,postschema),!e.success)return alertMessage(e.message);e=e.message,removeLoadingTab(s);const n=Array.from(a.querySelectorAll('span[name="info-hol"]'));for(const t of n){let a=t.getAttribute("data-hold");-1!=a.indexOf(".")?(a=a.split("."),t.innerText=e[a[0]][a[1]]):(-1!=t.getAttribute("data-hold").indexOf("status")&&"open"==e[t.getAttribute("data-hold")]&&t.classList.replace("btn-label-secondary","btn-label-success"),t.innerText=e[a])}const o=Array.from(document.querySelectorAll('ul[name="looping-info"]'));for(const t of o){let a=t.getAttribute("data-hold"),s=e[a];if(s)if(s.length){for(const e of s){let a=t.cloneNode(!0),s=a.querySelector(".data-buttons");s&&s.setAttribute("data-id",e.id);let n=Array.from(a.querySelectorAll('[name="looping-info-hol"]'));for(const t of n)t.innerText=e[t.getAttribute("data-hold")];t.parentNode.appendChild(a)}t.parentNode.removeChild(t)}else aDePh(t.parentElement),t.parentNode.removeChild(t)}let l=Array.from(a.querySelectorAll(".data-buttons"));l.forEach(async t=>{t.addEventListener("click",function(a){if(a.preventDefault(),t.classList.contains("loading"))return 0;let s=t.getAttribute("data-role"),n=new magic(e.id);switch(s){case"add-employee":n.addemployee(r.employees);break;case"add-department":n.adddepartment(r.departments);break;case"remove-employee":n.removeemployee(this);break;case"remove-medication":n.removeMedicine(this);break;case"remove-department":n.removedepartment(this)}})})}u=getdata("token"),u||(window.location.href="../../login"),m=await request("get-map",getschema),postschema.body=JSON.stringify({token:getdata("token")}),h=await request("gethospitals",postschema),d=await request("get-departments",postschema),e=await request("get-employees",postschema);let r={map:m.message,employees:e.message,hospitals:h.message,departments:d.message};try{if(!m.success||!d.success)return alertMessage(m.message);[m]=m.message,f=document.querySelector("form#add-health-post-form"),s=Array.from(f.querySelectorAll("select.address-field")),i=Array.from(f.querySelectorAll(".form-control")),z=Array.from(f.querySelectorAll(".form-select"));for(const e of z)i.push(e);b=f.querySelector('button[type="submit"]');for(const e of m.provinces)o=document.createElement("option"),s[0].appendChild(o),o.innerText=e.name,o.value=e.id,o.setAttribute("data-id",e.id);for(const e of s)e.addEventListener("change",a=>{if(a.preventDefault(),"province"==e.name)for(const a of m.provinces)a.id==e.value?(s[2].innerHTML='<option value="">Select Sector</option>',s[3].innerHTML='<option value="">Select Cell</option>',t(a.districts,s[1],"District")):""==e.value&&(s[1].innerHTML='<option value="">Select District</option>',s[2].innerHTML='<option value="">Select Sector</option>',s[3].innerHTML='<option value="">Select Cell</option>');if("district"==e.name)for(const a of m.provinces)for(const n of a.districts)n.id==e.value?(s[3].innerHTML='<option value="">Select Cell</option>',t(n.sectors,s[2],"Sector")):""==e.value&&(s[2].innerHTML='<option value="">Select Sector</option>',s[3].innerHTML='<option value="">Select Cell</option>');if("sector"==e.name)for(const a of m.provinces)for(const n of a.districts)for(const a of n.sectors)a.id==e.value?t(a.cells,s[3],"Cell"):""==e.value&&(s[3].innerHTML='<option value="">Choose...</option>')})}catch(e){console.log(e)}f.addEventListener("submit",async e=>{e.preventDefault(),v=1;for(const e of i)n=checkEmpty(e),n||(v=0);if(v){x={};for(const e of i)e.classList.contains("chips-check")?(c=getchips(e.parentNode.querySelector("div.chipsholder")),Object.assign(x,{[e.name]:c})):"phone"==e.name?Object.assign(x,{[e.name]:e.value.replace(/ /g,"")}):Object.assign(x,{[e.name]:e.value});Object.assign(x,{token:getdata("token")}),postschema.body=JSON.stringify(x),b.setAttribute("disabled",!0),b.textContent="Recording health post info...",a=await request("addhealthpost",postschema),b.removeAttribute("disabled"),b.textContent="Submit",a.success||alertMessage(a.message)}}),$(document).ready(function(){if(!h.success)return alertMessage(h.message);var e=$(".datatables-health-posts");e.DataTable({dom:'<"row mx-2"<"col-md-2"<"me-3"l>><"col-md-10"<"dt-action-buttons text-xl-end text-lg-start text-md-end text-start d-flex align-items-center justify-content-end flex-md-row flex-column mb-3 mb-md-0"fB>>>t<"row mx-2"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',language:{sLengthMenu:"_MENU_",search:"",searchPlaceholder:"Search..."},columns:[{data:""},{data:"name",title:"Health post name"},{data:"type",title:"Type"},{data:"location.province",title:"province"},{data:"location.district",title:"district"},{data:"location.sector",title:"sector"},{data:"location.cell",title:"cell"},{data:"Employees",title:"Employees"},{data:"id",title:"Action"}],columnDefs:[{className:"control",searchable:!1,orderable:!1,responsivePriority:2,targets:0,render:function(){return""}},{targets:1,searchable:1,orderable:1,render:function(e,t,a,s){return`<span class='d-block fw-semibold'>${e}</span>`}},{targets:3,searchable:1,orderable:1,render:function(e,t,a,s){return`<span class='d-block fw-semibold'>${e}</span>`}},{targets:4,searchable:1,orderable:1,render:function(e,t,a,s){return`<span class="capitalize"> ${e}</span>`}},{targets:5,searchable:1,orderable:1,render:function(e,t,a,s){return`<span class="capitalize"> ${e}</span>`}},{targets:6,searchable:1,orderable:1,render:function(e,t,a,s){return`<span class="capitalize"> ${e}</span>`}},{targets:7,searchable:!1,orderable:1,render:function(e,t,a,s){return`<span class="capitalize">${a.employees.length}</span>`}},{targets:-1,searchable:!1,orderable:!1,render:function(e,t,a,s){return`<div class="d-inline-block text-nowrap">\n                                <button class="btn btn-sm btn-icon" data-delete-button="true" data-id="${e}"><i class="bx bx-show-alt"></i></button>\n                                <button class="btn btn-sm btn-icon delete-health-post" data-id="${e}"><i class="bx bx-trash"></i></button>\n                            </div>`}}],order:[[1,"asc"]],data:h.message,buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle mx-3",text:'<i class="bx bx-export me-1"></i>Export',buttons:[{extend:"print",text:'<i class="bx bx-printer me-2" ></i>Print',className:"dropdown-item"},{extend:"excel",text:'<i class="bx bxs-file-export me-2"></i>Excel',className:"dropdown-item"},{extend:"pdf",text:'<i class="bx bxs-file-pdf me-2"></i>Pdf',className:"dropdown-item"}]},{text:'<i class="bx bx-plus me-0 me-sm-1"></i><span class="d-none d-sm-inline-block">Add New</span>',className:"add-new btn btn-primary",attr:{"data-bs-toggle":"modal","data-bs-target":"#add-health-post"}}],responsive:{details:{display:$.fn.dataTable.Responsive.display.modal({header:function(e){return"Details of "+e.data().name}}),type:"column",renderer:function(e,t,a){return a=$.map(a,function(e,t){return""!==e.title?'<tr data-dt-row="'+e.rowIndex+'" data-dt-column="'+e.columnIndex+'"><td>'+e.title+":</td> <td>"+e.data+"</td></tr>":""}).join(""),!!a&&$('<table class="table"/><tbody />').append(a)}}},initComplete:function(){this.api().columns(2).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Type </option></select>').appendTo(".health-post-type").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})}),this.api().columns(3).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Province </option></select>').appendTo(".health-post-province").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})}),this.api().columns(4).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select District </option></select>').appendTo(".health-post-district").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})}),this.api().columns(5).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Sector </option></select>').appendTo(".health-post-sector").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})}),this.api().columns(6).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Cell </option></select>').appendTo(".health-post-cell").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})})}});let t=Array.from(document.querySelectorAll('[data-delete-button="true"]'));t.forEach(function(e){e.addEventListener("click",t=>{if(e.classList.contains("loading"))return 0;t.preventDefault(),e.classList.add("loading");let a=e.getAttribute("data-id");l(a)})}),$("#add-health-post").on("shown.bs.modal",function(){const e=$(this);let t=f.querySelector("input#departments");t.addEventListener("focus",function(e){showRecs(this,d.message,"departments")}),initializeCleave(e.find(".phone-number-mask"),null)})})})();class magic{constructor(e){this.hospital=e}async addemployee(e){let t=addshade(),a=document.createElement("div");a.className="br-10p cntr card p-10p bsbb w-60 h-80 b-mgc-resp",t.appendChild(a),a.className="w-350p h-a p-10p bsbb bc-white cntr zi-10000 br-5p b-mgc-resp card",a.innerHTML='<div class="head w-100 h-50p py-10p px-15p bsbb">\n                            <span class="fs-18p bold-2 dgray capitalize igrid h-100 card-title">add an employee to a health facility</span>\n                        </div>\n                        <div class="body w-100 h-a p-5p grid">\n                            <form method="post" id="req-department-info-form" name="req-department-info-form">\n                                <div class="col-md-12 px-10p py-6p bsbb p-r">\n                                    <label for="department" class="form-label">employee\'s name</label>\n                                    <input type="text" class="form-control bevalue" id="employee" placeholder="employee" name="employee">\n                                    <small class="w-100 red pl-3p verdana"></small>\n                                </div>\n                                <div class="px-10p bsbb bblock-resp">\n                                    <button type="submit" class="btn btn-primary">Proceed</button>\n                                </div>\n                            </form>\n                        </div>';let s=a.querySelector("form"),n=Array.from(s.querySelectorAll("input")),o=n.find(function(e){return e.classList.contains("bevalue")});o.addEventListener("focus",t=>{showRecs(o,e,o.id)}),s.addEventListener("submit",async e=>{e.preventDefault(),l=1;for(const e of n)v=checkEmpty(e),v||(l=0);if(l){let e=s.querySelector('button[type="submit"]');e.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',e.setAttribute("disabled",!0);let a={};for(const e of n)Object.assign(a,{[e.name]:e.classList.contains("bevalue")?e.getAttribute("data-id"):e.value});Object.assign(a,{token:getdata("token"),hospital:this.hospital}),delete a.quantity,postschema.body=JSON.stringify(a);let o=await request("add-employee-to-hp",postschema);o.success&&deletechild(t,t.parentElement),alertMessage(o.message),e.removeAttribute("disabled"),e.innerHTML="proceed"}})}adddepartment(e){let t=addshade();a=document.createElement("div"),t.appendChild(a),a.className="w-350p h-a p-10p bsbb bc-white cntr zi-10000 br-5p b-mgc-resp card",a.innerHTML='<div class="head w-100 h-50p py-10p px-15p bsbb">\n                            <span class="fs-18p bold-2 dgray capitalize igrid h-100 card-title">add a department to restricted list</span>\n                        </div>\n                        <div class="body w-100 h-a p-5p grid">\n                            <form method="post" id="add-department-form" name="add-department-form">\n                                <div class="col-md-12 p-10p bsbb mb-5p p-r">\n                                    <label for="departments" class="form-label">departments</label>\n                                    <input type="text" class="form-control extras bevalue no-extra-info-addin" id="department" placeholder="department Name" name="department">\n                                    <small class="hidden w-100 red pl-3p verdana"></small>\n                                </div>\n                                <div class="wrap center-2 px-10p bsbb bblock-resp my-15p">\n                                    <button type="submit" class="btn btn-primary bfull-resp bm-a-resp bmy-10p-resp">Proceed</button>\n                                </div>\n                            </form>\n                        </div>';let s=a.querySelector("form"),n=Array.from(s.querySelectorAll("input")),o=n.find(function(e){return e.classList.contains("extras")});o.addEventListener("focus",t=>{showRecs(o,e,o.id)}),s.addEventListener("submit",async e=>{e.preventDefault(),l=1;for(const e of n)v=checkEmpty(e),v||(l=0);if(l){let e=s.querySelector('button[type="submit"]');e.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',e.setAttribute("disabled",!0);let a={};for(const e of n)Object.assign(a,{[e.name]:e.classList.contains("bevalue")?e.getAttribute("data-id"):e.value});Object.assign(a,{hospital:this.hospital,token:getdata("token")}),postschema.body=JSON.stringify(a);let o=await request("add-department-to-hp",postschema);o.success&&deletechild(t,t.parentElement),alertMessage(o.message),e.removeAttribute("disabled"),e.innerHTML="proceed"}})}async removeemployee(e){e.classList.add("loading"),e.setAttribute("disabled",!0),e.innerText="removing...",postschema.body=JSON.stringify({token:getdata("token"),type:"employees",hospital:this.hospital,employee:e.getAttribute("data-id")});let t=await request("remove-employee-from-hp",postschema);e.classList.remove("loading"),e.removeAttribute("disabled"),t.success?(alertMessage(t.message),deletechild(e.parentElement.parentElement.parentElement,e.parentElement.parentElement.parentElement.parentElement)):alertMessage(t.message)}async removedepartment(e){e.classList.add("loading"),e.setAttribute("disabled",!0),e.innerText="removing...",postschema.body=JSON.stringify({token:getdata("token"),type:"departments",hospital:this.hospital,department:e.getAttribute("data-id")});let t=await request("remove-department-from-hp",postschema);e.classList.remove("loading"),e.removeAttribute("disabled"),t.success?(alertMessage(t.message),deletechild(e.parentElement.parentElement.parentElement,e.parentElement.parentElement.parentElement.parentElement)):alertMessage(t.message)}}