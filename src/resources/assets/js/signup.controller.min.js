import{alertMessage,getdata,getschema,postschema,request,checkEmpty,initializeCleave,showRecs,getchips}from"../../../utils/functions.controller.js";let q,w,e,r,t,y,u,i,o,p,a,s,d,f,g,h,j,k,l,z,x,c,v,b,n,m;(async function(){function e(e,t,s){t.innerHTML='<option value="">Choose...</option>';for(const s of e)o=document.createElement("option"),o.innerText=s.name,o.value=s.id,o.setAttribute("data-id",s.id),t.appendChild(o)}m=await request("get-map",getschema),q=await request("get-assurances",getschema);try{if(m.success&&q.success){m=m.message,f=document.querySelector("form#formAuthentication"),s=Array.from(f.querySelectorAll("select.address-field")),g=Array.from(f.querySelectorAll("select.form-select")),i=Array.from(f.querySelectorAll("input"));let t=i.find(function(e){return"householder"==e.name}),n=i.filter(function(e){return"radio"==e.type});for(const e of n)e.addEventListener("mousedown",o=>{"patient"==e.value?(t.parentElement.classList.replace("hidden","block"),t.classList.toggle("optional")):(t.parentElement.classList.replace("block","hidden"),t.value=null,t.classList.toggle("optional"))});initializeCleave(f.querySelector("input.phone-number-mask"),f.querySelector("input.national-id-no-mask")),initializeCleave(null,t);for(const e of s)i.push(e);for(const e of g)i.push(e);b=f.querySelector('button[type="submit"]');for(let e of m)e=e.provinces[0],o=document.createElement("option"),s[0].appendChild(o),o.innerText=e.name,o.value=e.id,o.setAttribute("data-id",e.id);let a=f.querySelector("input#assurances");a.addEventListener("focus",function(e){showRecs(this,q.message,"assurances")});for(const o of s)o.addEventListener("change",t=>{if(t.preventDefault(),"province"==o.name)for(let t of m)t=t.provinces[0],t.id==o.value?(s[2].innerHTML='<option value="">Choose...</option>',s[3].innerHTML='<option value="">Choose...</option>',e(t.districts,s[1],"district")):""==o.value&&(s[1].innerHTML='<option value="">Choose...</option>',s[2].innerHTML='<option value="">Choose...</option>',s[3].innerHTML='<option value="">Choose...</option>');if("district"==o.name)for(let t of m){t=t.provinces[0];for(const n of t.districts)n.id==o.value?(s[3].innerHTML='<option value="">Choose...</option>',e(n.sectors,s[2],"sector")):""==o.value&&(s[2].innerHTML='<option value="">Choose...</option>',s[3].innerHTML='<option value="">Choose...</option>')}if("sector"==o.name)for(let t of m){t=t.provinces[0];for(const n of t.districts)for(const t of n.sectors)t.id==o.value?e(t.cells,s[3],"cell"):""==o.value&&(s[3].innerHTML='<option value="">Choose...</option>')}});f.addEventListener("submit",async e=>{let o,t,s,a,r;s="",a="",t={},v=1,e.preventDefault();for(const e of i)if(o=checkEmpty(e),o||(v=0),"phone"==e.name||"nid"==e.name||"householder"==e.name)Object.assign(t,{[e.name]:"phone"==e.name&&"+250"==e.value?null:e.value.replace(/ /g,"")});else if("firstname"==e.name)a+=`${e.value+Math.floor(999*Math.random()).toString().padStart(3,"0")}.`,s+=`${e.value} `;else if("lastname"==e.name)a+=`${e.value+Math.floor(999*Math.random()).toString().padStart(3,"0")}`,s+=`${e.value}`;else if(e.classList.contains("chips-check")){if(z=checkEmpty(e),z)if("assurances"==e.name){q=[];for(const o of getchips(e.parentNode.querySelector("div.chipsholder"),["id","number"]))Object.assign(o,{status:"eligible"}),q.push(o);Object.assign(t,{[e.name]:q})}else Object.assign(t,{[e.name]:getchips(e.parentNode.querySelector("div.chipsholder"))})}else Object.assign(t,{[e.name]:e.value});for(const e of n)e.checked&&Object.assign(t,{role:e.value});v&&(Object.assign(t,{Full_name:s}),Object.assign(t,{username:a}),postschema.body=JSON.stringify(t),console.log(t),r=await request("api/signup",postschema),alertMessage(r.message),r.success&&(localStorage.setItem("userid",t.username),window.location.href="../auth"))})}else alertMessage(m.message)}catch(e){console.log(e)}})();