import{alertMessage,getdata,getschema,postschema,request}from"../../../utils/functions.controller.js";let form=document.querySelector("form#twoStepsForm"),codein=Array.from(form.querySelectorAll("input.code-hol")),subbut=form.querySelector('button[type="submit"]');const resend_link=form.querySelector("a#resend-link");for(const e of codein)e.addEventListener("keyup",o=>{o.preventDefault(),1==e.value.trim().length?codein[codein.indexOf(e)+1]&&codein[codein.indexOf(e)+1].focus():1!=e.value.trim().length&&codein[codein.indexOf(e)-1]&&codein[codein.indexOf(e)-1].focus()});getdata("userid")||(window.location.href="../login/"),form.addEventListener("submit",async e=>{e.preventDefault();var o="";for(const e of codein){if(0==e.value.trim().length)return 0;o+=e.value.trim()}subbut.setAttribute("disabled",!0),subbut.innerText="Authenticating...",getdata("userid")||(window.location.href="../login/"),postschema.body=JSON.stringify({email:getdata("userid"),_2FA_code:o});let t=await request("verify",postschema);if(subbut.removeAttribute("disabled"),subbut.innerText="Verify",t.success){let e=await request(`authenticateToken/${t.message}`,getschema);e.success?(localStorage.removeItem("userid"),localStorage.setItem("token",t.message),e=e.message,"Admin"==e.role?window.location.href="../admin/home/":"patient"==e.role?window.location.href="../patient/home/":"hc_provider"==e.role?window.location.href="../hc_provider/home/":"pharmacist"==e.role?window.location.href="../pharmacist/home/":"cashier"==e.role?window.location.href="../cashier/home/":"receptionist"==e.role?window.location.href="../receptionist/home/":"director_general"==e.role?window.location.href="../dg/home/":"dof"==e.role?window.location.href="../dof/home/":"mohs"==e.role?window.location.href="../mohs/home/":"Human resource manager"==e.role?window.location.href="../hrm/home/":"laboratory_scientist"==e.role?window.location.href="../laboratory_scientist/home/":"insurance_manager"==e.role&&(window.location.href="../insurance_manager/home/")):console.log()}else alertMessage(t.message)}),resend_link.addEventListener("click",async e=>{if(e.preventDefault(),console.log("ddd"),!getdata("userid"))return alertMessage("user not found");subbut.setAttribute("disabled",!0),subbut.innerText="Sending Code";let o=getdata("userid");postschema.body=JSON.stringify({username:o});let t=await request("resend-2FA",postschema);subbut.removeAttribute("disabled"),subbut.innerText="Verify",alertMessage(t.message)});