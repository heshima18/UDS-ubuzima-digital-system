import{alertMessage,getdata,getschema,postschema,request,initializeCleave,sessiondata,addLoadingTab,removeLoadingTab,checkEmpty,showRecs,getchips,getPath,addsCard,cpgcntn,geturl,adcm,addshade,deletechild}from"../../../utils/functions.controller.js";import{addUprofile}from"../../../utils/user.profile.controller.js";import{expirateMssg,pushNotifs,userinfo}from"./nav.js";let q,w,e,t,y,u,i,o,p,a,s,d,f,g,h,j,k,l,x,c,v,b,n,m,z,session_input,session_s_button,eventadded;(async function(){async function e(e,t){try{if(x=e.id,"search-patient"==x)f=e.querySelector('form[name="sp-form"]'),s=f.querySelector('input[type="text"]'),setTimeout(e=>{s.focus()},200),b=f.querySelector('button[type="submit"]'),f.addEventListener("submit",async e=>(e.preventDefault(),s.value?(b.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',b.setAttribute("disabled",!0),r=await request(`patient/${s.value}`,postschema),b.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',b.removeAttribute("disabled"),r.success?void addUprofile(r.message):alertMessage(r.message)):0));else if("search-session"==x)f=e.querySelector('form[name="sp-form"]'),s=f.querySelector('input[type="text"]'),setTimeout(e=>{s.focus()},200),b=f.querySelector('button[type="submit"]'),f.addEventListener("submit",async e=>(e.preventDefault(),s.value?(b.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',b.setAttribute("disabled",!0),r=await request(`patient/${s.value}`,postschema),b.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',b.removeAttribute("disabled"),r.success?void addUprofile(r.message):alertMessage(r.message)):0));else if("my-account"==x){n=e.querySelector("span.name"),z=getdata("userinfo"),n.textContent=z.Full_name,i=e.querySelector("span-img"),i.textContent=z.Full_name.substring(0,1);let t=Array.from(e.querySelectorAll("span.icon-edit-icon"));for(const e of t)e.addEventListener("click",()=>{l=e.getAttribute("data-target"),shedtpopup(l,r)})}else if("view-prescription"==x){if(h.innerHTML=g,t){let e=new URL(window.location.href);e.pathname=`/cashier/view-prescription/${t}`,window.history.pushState({},"",e.toString())}let s=getPath(2);if(addLoadingTab(e.querySelector("div.theb")),session_input=e.querySelector("input#session-id"),session_s_button=e.querySelector('button[name="session-search"]'),eventadded||(session_s_button.addEventListener("click",async t=>{if(t.preventDefault(),session_input.value){s||removeLoadingTab(e.querySelector("div.theb")),s=session_input.value,postschema.body=JSON.stringify({token:getdata("token")}),addLoadingTab(e.querySelector("div.theb")),session_s_button.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',session_s_button.setAttribute("disabled",!0);let t=await request(`session/${s}`,postschema);if(t.success&&(h.innerHTML=g),session_s_button.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',session_s_button.removeAttribute("disabled"),!t.success)return alertMessage(t.message);session_input.value=s;let a=new URL(window.location.href);a.pathname=`/cashier/view-prescription/${s}`,window.history.pushState({},"",a.toString()),t=t.message,o(t)}}),eventadded=1),s){postschema.body=JSON.stringify({token:getdata("token")});let e=await request(`session/${s}`,postschema);if(!e.success)return alertMessage(e.message);session_input.value=s,e=e.message,o(e)}}function o(t){removeLoadingTab(e.querySelector("div.theb")),Object.assign(t.payment_info,{total_amount:Number(t.payment_info.a_amount)+Number(t.payment_info.p_amount)});const s=Array.from(document.querySelectorAll('[name="info-hol"]')),n=Array.from(document.querySelectorAll('ul[name="looping-info"]'));for(const e of n){let s=e.getAttribute("data-hold"),a=t[s];for(const t of a){Object.assign(t,{total_amount:(Number(t.price)*Number(t.quantity)).toFixed(2)});let a=e.cloneNode(!0),n=Array.from(a.querySelectorAll('[name="looping-info-hol"]'));a.getAttribute("data-id-holder")&&a.setAttribute("data-id",t.id),"medicines"==s&&("served"==t.status?(a.classList.add("bc-tr-green"),n.find(function(e){return"name"==e.getAttribute("data-hold")}).classList.replace("dgray","green")):a.classList.add("bc-gray"));for(const e of n)e.getAttribute("data-id-holder")&&e.setAttribute("data-id",t.id),-1!=e.getAttribute("data-hold").indexOf("quantity")||-1!=e.getAttribute("data-hold").indexOf("amount")?e.innerText=adcm(t[e.getAttribute("data-hold")]):-1!=e.getAttribute("data-hold").indexOf("status")&&"served"!=t[e.getAttribute("data-hold")]?(e.innerText="mark as served",e.classList.replace("btn-label-secondary","btn-label-primary"),e.setAttribute("data-active",!0)):e.innerText=t[e.getAttribute("data-hold")];e.parentNode.appendChild(a)}e.parentNode.removeChild(e)}for(const e of s){let s=e.getAttribute("data-hold");-1!=s.indexOf(".")?(s=s.split("."),-1!=s[1].indexOf("amount")?e.innerText=adcm(t[s[0]][s[1]]):-1!=s[1].indexOf("status")&&-1!=s[0].indexOf("payment_info")?("paid"==t[s[0]][s[1]]&&e.classList.replace("btn-label-secondary","btn-label-success"),e.innerText=t[s[0]][s[1]]):e.innerText=t[s[0]][s[1]]):(-1!=e.getAttribute("data-hold").indexOf("status")&&"open"==t[e.getAttribute("data-hold")]&&e.classList.replace("btn-label-secondary","btn-label-success"),e.innerText=t[s])}let r=Array.from(e.querySelectorAll("span.mark-button")),i=Array.from(e.querySelectorAll("span.data-buttons"));r=r.filter(function(e){return"true"==e.getAttribute("data-active")}),r.map(function(s){s.addEventListener("click",async function(){if(s.classList.contains("loading"))return 0;let a=this.getAttribute("data-id");postschema.body=JSON.stringify({token:getdata("token"),medicines:[a],session:t.session_id}),s.innerHTML='<span class="spinner-border"></span>',s.setAttribute("disabled",!0);let n=await request("mark-as-served",postschema);if(s.classList.remove("loading"),s.removeAttribute("disabled"),n.success){s.innerHTML="served",s.classList.replace("btn-label-primary","btn-label-secondary");let t=s.parentNode.parentNode.parentNode;t.classList.replace("bc-gray","bc-tr-green"),s.removeAttribute("data-active"),t.querySelector("span.card-title").classList.replace("dgray","green"),r=Array.from(e.querySelectorAll("span.mark-button")),r=r.filter(function(e){return"true"==e.getAttribute("data-active")})}else s.innerHTML="mark as served";alertMessage(n.message)})}),i.map(function(e){"awaiting payment"!=t.payment_info.status&&"approve-payment"==e.getAttribute("data-role")?(e.classList.add("loading"),e.classList.replace("btn-label-success","btn-label-secondary"),e.innerHTML="this session is already paid"):"awaiting payment"!=t.payment_info.status&&"request-payment"==e.getAttribute("data-role")&&deletechild(e,e.parentElement),e.addEventListener("click",async function(s){let n=this.getAttribute("data-role");if("approve-payment"!=n||e.classList.contains("loading")){if("comment"==n){let e=async e=>{const s=t;let n=addshade();a=document.createElement("div"),n.appendChild(a),a.className="w-350p h-a p-10p bsbb bc-white cntr zi-10000 br-5p b-mgc-resp card",a.innerHTML=`<div class="head w-100 h-50p py-10p px-15p bsbb">\n                                                <span class="fs-18p bold-2 dgray capitalize igrid h-100 card-title">add an operation to session</span>\n                                            </div>\n                                            <div class="body w-100 h-a p-5p grid">\n                                                <form method="post" id="req-test-info-form" name="req-test-info-form">\n                                                    <div class="col-md-12 px-10p py-6p bsbb p-r">\n                                                        <label for="test" class="form-label">comment</label>\n                                                        <textarea class="form-control" id="comment" placeholder="Demo comment" name="comment">${e}</textarea>\n                                                        <small class="w-100 red pl-3p verdana"></small>\n                                                    </div>\n                                                    <div class="wrap center-2 my-15p bsbb bblock-resp">\n                                                        <button type="submit" class="btn btn-primary mx-10p bfull-resp bm-a-resp bmy-10p-resp">Proceed</button>\n                                                    </div>\n                                                </form>\n                                            </div>`;let r=a.querySelector("form"),i=Array.from(r.querySelectorAll(".form-control"));r.addEventListener("submit",async e=>{e.preventDefault(),l=1;for(const e of i)v=checkEmpty(e),v||(l=0);if(l){let e=r.querySelector('button[type="submit"]');e.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',e.setAttribute("disabled",!0);let t={};for(const e of i)Object.assign(t,{[e.name]:e.classList.contains("bevalue")?e.getAttribute("data-id"):e.value});Object.assign(t,{session:s.session_id,token:getdata("token")}),postschema.body=JSON.stringify(t);let a=await request("add-session-comment",postschema);a.success&&deletechild(n,n.parentElement),alertMessage(a.message),e.removeAttribute("disabled"),e.innerHTML="proceed"}})};e(t.comment)}}else{if("paid"==t.payment_info.status)return alertMessage("this session is already paid");postschema.body=JSON.stringify({session:t.session_id,token:getdata("token")}),e.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',e.setAttribute("disabled",!0);let s=await request("approve-payment",postschema);s.success?(e.innerHTML="this session is already paid",e.classList.replace("btn-label-success","btn-label-secondary"),e.classList.add("loading"),document.querySelector("span.status-holder").classList.replace("btn-label-secondary","btn-label-success"),document.querySelector("span.status-holder").innerText="paid",t.payment_info.status="paid"):e.innerHTML="approve payment",alertMessage(s.message)}})})}}catch(e){console.log(e)}}z=userinfo;let o=getdata("token");if(o||(window.location.href="../../login/"),!z.success)return localStorage.removeItem("token"),alertMessage(z.message);if(z.success){z=z.message;try{const e=io(geturl(),{query:{id:z.id}});e.on("connect",()=>{console.log("Connected to the server")}),e.on("message",e=>{pushNotifs(e),addsCard(e.title,!0)}),e.on("expiratemssg",e=>{expirateMssg(e)}),e.on("selecthp",t=>{var s=document.createElement("div");document.body.appendChild(s);for(const e of t)s.innerHTML+=`<div id="${e.id}" class="verdana hover p-5p">${e.name}</div>`;let a=s.querySelectorAll("div");a.forEach(t=>{t.addEventListener("click",s=>{s.preventDefault(),e.emit("hpchoosen",{hp:t.id,token:localStorage.getItem("token")})})})}),e.on("changetoken",e=>{window.alert("token changed"),localStorage.setItem("token",e),window.location.href=window.location.href}),e.emit("messageToId",{recipientId:z.id,message:"wassup"}),"string"!=typeof z.hospital&&"object"==typeof z.hospital&&z.hospital.length>0&&e.emit("getpsforselection",z.hospital)}catch(e){console.log(e)}}postschema.body=JSON.stringify({token:o});let d=await request("get-hp-employees",postschema);if(!d.success)return alertMessage(d.message);let u={users:d.message};a=getPath(1),c=Array.from(document.querySelectorAll("span.cpcards")),p=Array.from(document.querySelectorAll("div.pagecontentsection"));const m=p.find(function(e){return"view-prescription"==e.id}),h=m.querySelector("div.theb"),g=h.innerHTML;a?p.forEach(s=>{if(a==s.id)return t=p.indexOf(s),c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),c[t].classList.add("active","bb-1-s-theme","bc-tr-theme","theme"),cpgcntn(t,p,u),e(s),0}):(window.history.pushState("","","./home"),cpgcntn(0,p,u)),window.onpopstate=function(){a=getPath(1),a?p.forEach(s=>{if(a==s.id)return t=p.indexOf(s),c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),c[t].classList.add("active","bb-1-s-theme","bc-tr-theme","theme"),cpgcntn(t,p),e(s),0}):(window.history.pushState("","","./home"),cpgcntn(0,p),e(p[0]))},c.forEach(t=>{t.addEventListener("click",()=>{c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),t.classList.add("active","bb-1-s-theme","bc-tr-theme","theme");let s=new URL(window.location.href);s.pathname=`/cashier/${t.getAttribute("data-item-type")}`,window.history.pushState({},"",s.toString()),cpgcntn(c.indexOf(t),p,u),e(p.find(function(e){return e.id==t.getAttribute("data-item-type")}))})})})();