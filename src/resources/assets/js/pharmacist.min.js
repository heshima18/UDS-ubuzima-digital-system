import{alertMessage,getdata,getschema,postschema,request,initializeCleave,sessiondata,addLoadingTab,removeLoadingTab,checkEmpty,showRecs,getchips,getPath,addsCard,cpgcntn,geturl,adcm,addshade,deletechild}from"../../../utils/functions.controller.js";import{pushNotifs,userinfo,expirateMssg,getNfPanelLinks,m as messages,DateTime}from"./nav.js";let q,w,e,t,y,u,i,o,p,a,s,d,f,g,h,j,k,l,x,c,v,b,n,m,z,notificationlinks;(async function(){async function o(t,o){try{if(x=t.id,"search-session"==x)f=t.querySelector('form[name="sp-form"]'),s=f.querySelector('input[type="text"]'),setTimeout(e=>{s.focus()},200),b=f.querySelector('button[type="submit"]'),f.addEventListener("submit",async e=>(e.preventDefault(),s.value?(b.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',b.setAttribute("disabled",!0),r=await request(`patient/${s.value}`,postschema),b.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',b.removeAttribute("disabled"),r.success?void 0:alertMessage(r.message)(r.message)):0));else if("my-account"==x){n=t.querySelector("span.name"),z=getdata("userinfo"),n.textContent=z.Full_name,i=t.querySelector("span.n-img"),i.textContent=z.Full_name.substring(0,1);let e=Array.from(t.querySelectorAll("span.icon-edit-icon"));for(const t of e)t.addEventListener("click",()=>{l=t.getAttribute("data-target"),shedtpopup(l,r)})}else if("manage-inventory"==x){var c=$(".datatables-employees");let a=document.querySelector("table");a.classList.contains("loaded")||(e=c.DataTable({dom:'<"row mx-2"<"col-md-2"<"me-3"l>><"col-md-10"<"dt-action-buttons text-xl-end text-lg-start text-md-end text-start d-flex align-items-center justify-content-end flex-md-row flex-column mb-3 mb-md-0"fB>>>t<"row mx-2"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',language:{sLengthMenu:"_MENU_",search:"",searchPlaceholder:"Search..."},columns:[{data:""},{data:"name",title:"Name"},{data:"quantity",title:"amount available"},{data:"unit",title:"measuring unit"},{data:"id",title:"Action"}],columnDefs:[{className:"control",searchable:!1,orderable:!1,responsivePriority:2,targets:0,render:function(){return""}},{targets:1,searchable:!1,orderable:1,render:function(e,t,a,s){return`<span class="capitalize">${e}</span>`}},{targets:2,searchable:!1,orderable:1,render:function(e,t,a,s){return`<span class="">${adcm(e)}</span>`}},{targets:-1,searchable:!1,orderable:!1,render:function(e,t,a,s){return`<div class="d-inline-block text-nowrap">\n                                        <button class="btn btn-sm btn-icon data-buttns" data-type="medicines" data-role="edit" data-id="${e}" data-bs-target = "#edit-medicine"><i class="bx bx-edit"></i></button>\n                                        <button class="btn btn-sm btn-icon data-buttns" data-type="medicines" data-role="delete" data-id="${e}"><i class="bx bx-trash"></i></button>\n                                    </div>`}}],order:[[1,"asc"]],data:f.message.medicines,buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle mx-3",text:'<i class="bx bx-export me-1"></i>Export',buttons:[{extend:"print",text:'<i class="bx bx-printer me-2" ></i>Print',className:"dropdown-item"},{extend:"excel",text:'<i class="bx bxs-file-export me-2"></i>Excel',className:"dropdown-item"},{extend:"pdf",text:'<i class="bx bxs-file-pdf me-2"></i>Pdf',className:"dropdown-item"}]},{text:'<i class="bx bx-plus me-0 me-sm-1"></i><span class="d-none d-sm-inline-block">Add New</span>',className:"add-new btn btn-primary",attr:{id:"add-medic","data-bs-target":"#add-medicine"}}],initComplete:function(){this.api().columns(3).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Measuring Unit </option></select>').appendTo(".employee-position").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})})}}));let s=document.querySelector("#add-medic"),n=Array.from(t.querySelectorAll("button.data-buttns"));s.onclick=function(){let e=this.getAttribute("data-bs-target"),t=document.querySelector(`div${e}`);t=t.cloneNode(!0),d=addshade(),d.appendChild(t);let a=t.querySelector("form#add-medicine-form"),s=a.querySelector('input[name="medicines"]');s.addEventListener("focus",e=>{e.preventDefault(),showRecs(s,m.message,s.id)}),a.addEventListener("submit",async e=>{if(e.preventDefault(),v=checkEmpty(s),v){let e=a.querySelector('button[type="submit"]');e.innerText="Recording medication(s)",e.setAttribute("disabled",!0);let t={};Object.assign(t,{[s.name]:getchips(s.parentNode.querySelector("div.chipsholder"),["id","quantity"])}),Object.assign(t,{token:getdata("token")}),postschema.body=JSON.stringify(t);let n=await request("add-inventory",postschema);n.success&&deletechild(d,d.parentNode),alertMessage(n.message),e.removeAttribute("disabled"),e.innerText="proceed"}})},n.forEach(t=>{t.onclick=async function(t){t.preventDefault();let a=this.getAttribute("data-role"),s=this.getAttribute("data-id"),n=this.getAttribute("data-type");if("delete"==a){postschema.body=JSON.stringify({token:getdata("token"),type:n,inventory:f.message.id,needle:s});var i=e.row(t.target.closest("tr"));i.remove().draw();let a=await request("rIFromInv",postschema);a.success,alertMessage(a.message)}else if("edit"==a){let e=f.message.medicines.find(function(e){return e.id==s}),t=this.getAttribute("data-bs-target"),a=document.querySelector(`div${t}`);a=a.cloneNode(!0),d=addshade(),d.appendChild(a);let n=a.querySelector("form#edit-medicine-form"),i=n.querySelector('input[name="medicine"]'),r=n.querySelector('input[name="quantity"]');i.value=e.name,i.setAttribute("readonly",!0),i.setAttribute("disabled",!0),i.setAttribute("data-id",e.id),r.value=e.quantity,n.addEventListener("submit",async e=>{if(e.preventDefault(),v=checkEmpty(r),v){let e=n.querySelector('button[type="submit"]');e.innerText="Editing entry",e.setAttribute("disabled",!0);let t={};Object.assign(t,{needle:i.getAttribute("data-id"),upinfo:{quantity:r.value},type:"medicines",inventory:f.message.id}),Object.assign(t,{token:getdata("token")}),postschema.body=JSON.stringify(t);let a=await request("eInvEnt",postschema);a.success&&deletechild(d,d.parentNode),alertMessage(a.message),e.removeAttribute("disabled"),e.innerText="proceed"}})}}}),a.classList.add("loaded")}else if("view-session"==x){if(w.innerHTML=L,o){let e=new URL(window.location.href);e.pathname=`/pharmacist/view-session/${o}`,window.history.pushState({},"",e.toString())}let e=getPath(2);addLoadingTab(t.querySelector("div.theb"));let a=t.querySelector("input#session-id"),s=t.querySelector('button[name="session-search"]');if(s.addEventListener("click",async n=>{if(n.preventDefault(),a.value&&a.value!=e){e||removeLoadingTab(t.querySelector("div.theb")),e=a.value,postschema.body=JSON.stringify({token:getdata("token")}),addLoadingTab(t.querySelector("div.theb")),s.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',s.setAttribute("disabled",!0);let n=await request(`session/${e}`,postschema);if(n.success&&(w.innerHTML=L),s.innerHTML='<i class="bx bx-search h-20p w-a center"></i>',s.removeAttribute("disabled"),!n.success)return alertMessage(n.message);a.value=e;let i=new URL(window.location.href);i.pathname=`/pharmacist/view-session/${e}`,window.history.pushState({},"",i.toString()),n=n.message,u(n)}}),e){postschema.body=JSON.stringify({token:getdata("token")});let t=await request(`session/${e}`,postschema);if(!t.success)return alertMessage(t.message);a.value=e,t=t.message,u(t)}}function u(e){removeLoadingTab(t.querySelector("div.theb")),Object.assign(e.payment_info,{total_amount:Number(e.payment_info.a_amount)+Number(e.payment_info.p_amount)});const s=Array.from(document.querySelectorAll('[name="info-hol"]')),n=Array.from(document.querySelectorAll('ul[name="looping-info"]'));for(const t of n){let a=t.getAttribute("data-hold"),s=e[a];for(const e of s){Object.assign(e,{total_amount:(Number(e.price)*Number(e.quantity)).toFixed(2)});let s=t.cloneNode(!0),n=Array.from(s.querySelectorAll('[name="looping-info-hol"]'));s.getAttribute("data-id-holder")&&s.setAttribute("data-id",e.id),"medicines"==a&&("served"==e.status?(s.classList.add("bc-tr-green"),n.find(function(e){return"name"==e.getAttribute("data-hold")}).classList.replace("dgray","green")):s.classList.add("bc-gray"));for(const t of n)t.getAttribute("data-id-holder")&&t.setAttribute("data-id",e.id),-1!=t.getAttribute("data-hold").indexOf("quantity")||-1!=t.getAttribute("data-hold").indexOf("amount")?t.innerText=adcm(e[t.getAttribute("data-hold")]):-1!=t.getAttribute("data-hold").indexOf("status")&&"served"!=e[t.getAttribute("data-hold")]?(t.innerText="mark as served",t.classList.replace("btn-label-secondary","btn-label-primary"),t.setAttribute("data-active",!0)):t.innerText=e[t.getAttribute("data-hold")];t.parentNode.appendChild(s)}t.parentNode.removeChild(t)}for(const t of s){let a=t.getAttribute("data-hold");-1!=a.indexOf(".")?(a=a.split("."),-1!=a[1].indexOf("amount")?t.innerText=adcm(e[a[0]][a[1]]):t.innerText=e[a[0]][a[1]]):(-1!=t.getAttribute("data-hold").indexOf("status")&&"open"==e[t.getAttribute("data-hold")]&&t.classList.replace("btn-label-secondary","btn-label-success"),t.innerText=e[a])}let i=Array.from(t.querySelectorAll("span.mark-button")),r=Array.from(t.querySelectorAll("span.data-buttons"));e.medicines.forEach(function(e){"served"!=e.status&&(d=1)}),d||(r[0].classList.add("loading"),r[0].classList.replace("btn-primary","btn-secondary"),r[0].innerHTML="all marked as served"),i=i.filter(function(e){return"true"==e.getAttribute("data-active")}),i.map(function(a){a.addEventListener("click",async function(){if(a.classList.contains("loading"))return 0;let s=this.getAttribute("data-id");postschema.body=JSON.stringify({token:getdata("token"),medicines:[s],session:e.session_id}),a.innerHTML='<span class="spinner-border"></span>',a.setAttribute("disabled",!0);let n=await request("mark-as-served",postschema);if(a.classList.remove("loading"),a.removeAttribute("disabled"),n.success){a.innerHTML="served",a.classList.replace("btn-label-primary","btn-label-secondary");let e=a.parentNode.parentNode.parentNode;e.classList.replace("bc-gray","bc-tr-green"),a.removeAttribute("data-active"),e.querySelector("span.card-title").classList.replace("dgray","green"),i=Array.from(t.querySelectorAll("span.mark-button")),i=i.filter(function(e){return"true"==e.getAttribute("data-active")})}else a.innerHTML="mark as served";alertMessage(n.message)})}),r.map(function(s){s.addEventListener("click",async function(n){let r=this.getAttribute("data-role");if("medication"!=r||s.classList.contains("loading")){if("comment"==r){let t=async t=>{const s=e;let n=addshade();a=document.createElement("div"),n.appendChild(a),a.className="w-350p h-a p-10p bsbb bc-white cntr zi-10000 br-5p b-mgc-resp card",a.innerHTML=`<div class="head w-100 h-50p py-10p px-15p bsbb">\n                                                <span class="fs-18p bold-2 dgray capitalize igrid h-100 card-title">add an operation to session</span>\n                                            </div>\n                                            <div class="body w-100 h-a p-5p grid">\n                                                <form method="post" id="req-test-info-form" name="req-test-info-form">\n                                                    <div class="col-md-12 px-10p py-6p bsbb p-r">\n                                                        <label for="test" class="form-label">comment</label>\n                                                        <textarea class="form-control" id="comment" placeholder="Demo comment" name="comment">${t}</textarea>\n                                                        <small class="w-100 red pl-3p verdana"></small>\n                                                    </div>\n                                                    <div class="wrap center-2 my-15p bsbb bblock-resp">\n                                                        <button type="submit" class="btn btn-primary mx-10p bfull-resp bm-a-resp bmy-10p-resp">Proceed</button>\n                                                    </div>\n                                                </form>\n                                            </div>`;let i=a.querySelector("form"),r=Array.from(i.querySelectorAll(".form-control"));i.addEventListener("submit",async e=>{e.preventDefault(),l=1;for(const e of r)v=checkEmpty(e),v||(l=0);if(l){let e=i.querySelector('button[type="submit"]');e.innerHTML='<span class="spinner-border" role="status" aria-hidden="true"></span>',e.setAttribute("disabled",!0);let t={};for(const e of r)Object.assign(t,{[e.name]:e.classList.contains("bevalue")?e.getAttribute("data-id"):e.value});Object.assign(t,{session:s.session_id,token:getdata("token")}),postschema.body=JSON.stringify(t);let a=await request("add-session-comment",postschema);a.success&&deletechild(n,n.parentElement),alertMessage(a.message),e.removeAttribute("disabled"),e.innerHTML="proceed"}})};t(e.comment)}}else{let a=e.medicines.map(function(e){if(!e.servedOut&&"served"!=e.status)return e=e.id,e});a=a.filter(function(e){return null!=e}),postschema.body=JSON.stringify({token:getdata("token"),medicines:a,session:e.session_id}),s.innerHTML='<span class="spinner-border"></span>',s.setAttribute("disabled",!0),s.classList.add("loading");let n=await request("mark-as-served",postschema);if(s.classList.remove("loading"),n.success){s.innerHTML="all marked as served",s.classList.replace("btn-primary","btn-secondary");let e=s.parentNode.parentNode.parentNode;console.log(e);let a=Array.from(e.querySelectorAll("ul"));a.map(function(e){e.classList.replace("bc-gray","bc-tr-green"),e.querySelector("span.mark-button").removeAttribute("data-active"),e.querySelector("span.mark-button").setAttribute("disabled",!0),e.querySelector("span.mark-button").classList.replace("btn-label-primary","btn-label-secondary"),e.querySelector("span.mark-button").textContent="served",e.querySelector("span.card-title").classList.replace("dgray","green"),i=Array.from(t.querySelectorAll("span.mark-button")),i=i.filter(function(e){return"true"==e.getAttribute("data-active")}),i.length||s.classList.add("loading")})}else s.removeAttribute("disabled"),s.innerHTML="mark all as served";alertMessage(n.message)}})})}}catch(e){console.log(e)}}function u(e){let t=sessiondata("messages");e.map(e=>{e.addEventListener("click",()=>{if(!e.classList.contains("list-link"))return 0;v=document.querySelector(`div#${e.getAttribute("data-href-target")}`);let a=t.find(function(t){return t.id==e.getAttribute("data-id")});if(v&&a){p=Array.from(v.parentElement.querySelectorAll(".pagecontentsection")),s=p.indexOf(v);let t=new URL(window.location.href);if("session_message"==e.getAttribute("data-message-type")){let s;a.addins?s=a.addins.session:a.extra&&(s=a.extra.session),s&&(t.pathname=`/${getPath()[0]}/${e.getAttribute("data-href-target")}/${s}`)}else"__APPNTMNT_MSSG_"==e.getAttribute("data-message-type")?(appApprovalCont(a),t.pathname=`/${getPath()[0]}/${e.getAttribute("data-href-target")}`):t.pathname=`/${getPath()[0]}/${e.getAttribute("data-href-target")}`;window.history.pushState({},"",t.toString()),cpgcntn(p.indexOf(v),p),o(v,null)}})})}z=userinfo;let g=getdata("token");if(g||(window.location.href="../../login/"),!z.success)return localStorage.removeItem("token"),alertMessage(z.message);if(z.success){z=z.message;try{const e=io(geturl(),{query:{id:z.id}});e.on("connect",()=>{console.log("Connected to the server")}),e.on("message",e=>{pushNotifs(e),messages.push(e),notificationlinks=getNfPanelLinks(),u(notificationlinks),addsCard(e.title,!0)}),e.on("expiratemssg",e=>{expirateMssg(e)}),e.on("selecthp",t=>{var a=document.createElement("div");document.body.appendChild(a);for(const e of t)a.innerHTML+=`<div id="${e.id}" class="verdana hover p-5p">${e.name}</div>`;let s=a.querySelectorAll("div");s.forEach(t=>{t.addEventListener("click",a=>{a.preventDefault(),e.emit("hpchoosen",{hp:t.id,token:localStorage.getItem("token")})})})}),e.on("changetoken",e=>{window.alert("token changed"),localStorage.setItem("token",e),window.location.href=window.location.href}),e.emit("messageToId",{recipientId:z.id,message:"wassup"}),"string"!=typeof z.hospital&&"object"==typeof z.hospital&&z.hospital.length>0&&e.emit("getpsforselection",z.hospital)}catch(e){console.log(e)}}postschema.body=JSON.stringify({token:g});let h=await request("get-hp-employees",postschema);if(f=await request("get-inventory",postschema),m=await request("getmeds",postschema),!f.success)return alertMessage(f.message);let y={users:h.message,tests:f.message};a=getPath(1),c=Array.from(document.querySelectorAll("span.cpcards")),p=Array.from(document.querySelectorAll("div.pagecontentsection"));const A=p.find(function(e){return"view-session"==e.id}),w=A.querySelector("div.theb"),L=w.innerHTML;a?p.forEach(e=>{if(a==e.id)return t=p.indexOf(e),c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),c[t].classList.add("active","bb-1-s-theme","bc-tr-theme","theme"),cpgcntn(t,p,y),o(e),0}):(window.history.pushState("","","./home"),cpgcntn(0,p,y)),window.onpopstate=function(){a=getPath(1),a?p.forEach(e=>{if(a==e.id)return t=p.indexOf(e),c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),c[t].classList.add("active","bb-1-s-theme","bc-tr-theme","theme"),cpgcntn(t,p),o(e),0}):(window.history.pushState("","","./home"),cpgcntn(0,p),o(p[0]))},c.forEach(e=>{e.addEventListener("click",()=>{c.forEach(e=>{e.classList.remove("active","bb-1-s-theme","bc-tr-theme","theme")}),e.classList.add("active","bb-1-s-theme","bc-tr-theme","theme");let t=new URL(window.location.href);t.pathname=`/pharmacist/${e.getAttribute("data-item-type")}`,window.history.pushState({},"",t.toString()),cpgcntn(c.indexOf(e),p,y),o(p.find(function(t){return t.id==e.getAttribute("data-item-type")}))})}),notificationlinks=getNfPanelLinks(),u(notificationlinks)})();