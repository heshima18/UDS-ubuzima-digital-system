import{alertMessage,getdata,getschema,postschema,request,initializeCleave,checkEmpty,showRecs,addshade,getLocs,deletechild}from"../../../utils/functions.controller.js";$(document).ready(async function(){async function e(){let e=addshade();n=document.createElement("div"),e.appendChild(n),n.className="w-350p h-a p-10p bsbb bc-white cntr zi-10000 br-5p b-mgc-resp card",n.innerHTML='<div class="head w-100 h-50p py-10p px-15p bsbb">\n                            <span class="fs-18p bold-2 dgray capitalize igrid h-100 card-title">Staff additional info</span>\n                        </div>\n                        <div class="body w-100 h-a p-5p grid">\n                            <form method="post" id="req-info-form" name="req-info-form">\n                                <div class="col-md-12 px-10p py-6p bsbb p-r">\n                                    <label for=" class="form-label">Limit</label>\n                                    <input type="text" class="form-control bevalue" id="limit" placeholder="Demo Limit" name="limit">\n                                    <small class="w-100 red pl-3p verdana"></small>\n                                </div>\n                                <div class="col-md-12 px-10p py-6p bsbb p-r">\n                                    <label for="Location" class="form-label">Location</label>\n                                    <input type="text" class="form-control bevalue" id="Location" placeholder="Demo Location" name="location">\n                                    <small class="w-100 red pl-3p verdana"></small>\n                                </div>\n                                <div class="wrap center-2 px-10p bsbb bblock-resp my-10p">\n                                    <button type="submit" class="btn btn-primary bfull-resp mr-10p bm-a-resp bmy-10p-resp">Proceed</button>\n                                </div>\n                            </form>\n                        </div>';let t=n.querySelector("form"),a=Array.from(n.querySelectorAll("input")),o=a.find(function(e){return"limit"==e.name}),s=a.find(function(e){return"location"==e.name});s.addEventListener("focus",e=>{showRecs(s,getLocs(v.message,o.getAttribute("data-id")),s.id)}),o.addEventListener("focus",e=>{showRecs(o,[{id:"province",name:"province"},{id:"district",name:"district"},{id:"sector",name:"sector"}],o.id)}),t.addEventListener("submit",async t=>{t.preventDefault();let n=1;for(const e of a)l=checkEmpty(e),l||(n=0);if(n){let t={};for(const e of a)Object.assign(t,{[e.name]:e.classList.contains("bevalue")?e.getAttribute("data-id"):e.value});h=t,deletechild(e,e.parentElement)}})}function t(){let t=document.querySelector("#add-employee");t=t.cloneNode(!0);let s=addshade();s.appendChild(t),r=t.querySelector("form#add-employee-form"),p=Array.from(r.querySelectorAll("select.address-field")),d=Array.from(r.querySelectorAll(".form-control")),i=Array.from(r.querySelectorAll(".form-select"));for(const e of i)d.push(e);u=r.querySelector('button[type="submit"]');for(const e of p)e.addEventListener("change",t=>{if(t.preventDefault(),"province"==e.name)for(const t of m.provinces)t.id==e.value?(p[2].innerHTML='<option value="">Select Sector</option>',p[3].innerHTML='<option value="">Select Cell</option>',cdcts(t.districts,p[1],"District")):""==e.value&&(p[1].innerHTML='<option value="">Select District</option>',p[2].innerHTML='<option value="">Select Sector</option>',p[3].innerHTML='<option value="">Select Cell</option>');if("district"==e.name)for(const t of m.provinces)for(const a of t.districts)a.id==e.value?(p[3].innerHTML='<option value="">Select Cell</option>',cdcts(a.sectors,p[2],"Sector")):""==e.value&&(p[2].innerHTML='<option value="">Select Sector</option>',p[3].innerHTML='<option value="">Select Cell</option>');if("sector"==e.name)for(const t of m.provinces)for(const a of t.districts)for(const t of a.sectors)t.id==e.value?cdcts(t.cells,p[3],"Cell"):""==e.value&&(p[3].innerHTML='<option value="">Choose...</option>')});r.addEventListener("submit",async e=>{e.preventDefault(),l=1;for(const e of d)o=checkEmpty(e),o||(l=0);if(l){f={};for(const e of d)e.classList.contains("chips-check")?(b=getchips(e.parentNode.querySelector("div.chipsholder")),Object.assign(f,{[e.name]:b})):"phone"==e.name||"nid"==e.name?Object.assign(f,{[e.name]:e.value.replace(/ /g,"")}):e.classList.contains("bevalue")?Object.assign(f,{[e.name]:e.getAttribute("data-id")}):Object.assign(f,{[e.name]:e.value});Object.assign(f,{token:getdata("token"),extra:h}),postschema.body=JSON.stringify(f),u.setAttribute("disabled",!0),u.textContent="Recording employee...",n=await request("addemployee",postschema),u.removeAttribute("disabled"),u.textContent="Submit",n.success?(alertMessage(n.message),r.reset()):alertMessage(n.message)}});let v=r.querySelector("input#hospital"),g=r.querySelector("input#department"),y=a.message;y=y.map(function(e){return{id:e,name:e}});let x=d.find(function(e){return"title"==e.name});v.addEventListener("focus",function(e){showRecs(this,c.message,"hospital")}),x.addEventListener("focus",function(e){showRecs(this,y,"titles")}),x.onblur=async function(){let t=this.getAttribute("data-id");"Ministry of health staff"==t&&(h=await e())},g.addEventListener("focus",function(e){let t=c.message.find(function(e){return e.id==v.getAttribute("data-id")});t?(t=t.departments,showRecs(this,t,"department")):showRecs(this,o.message,"department")}),initializeCleave(r.querySelector(".phone-number-mask"),r.querySelector(".national-id-no-musk"))}let a,n,o,s,i,l,c,r,d,p,u,f,b,h;s=getdata("token"),s||(window.location.href="../../login"),postschema.body=JSON.stringify({token:s}),l=await request("get-employees",postschema),o=await request("get-departments",postschema),c=await request("gethospitals",postschema),a=await request("get-titles",postschema);const v=await request("get-map",getschema);if(!l.success||!o.success||!c.success)return alertMessage(l.message);for(const e of l.message)Object.assign(l.message[l.message.indexOf(e)],{image:""});var g=$(".datatables-employees"),y=g.DataTable({dom:'<"row mx-2"<"col-md-2"<"me-3"l>><"col-md-10"<"dt-action-buttons text-xl-end text-lg-start text-md-end text-start d-flex align-items-center justify-content-end flex-md-row flex-column mb-3 mb-md-0"fB>>>t<"row mx-2"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',language:{sLengthMenu:"_MENU_",search:"",searchPlaceholder:"Search..."},columns:[{data:""},{data:"name",title:"Names"},{data:"nid",title:"NID"},{data:"position",title:"Position"},{data:"hp",title:"Health Post"},{data:"department",title:"Department"},{data:"status",title:"Status"},{data:"action",title:"Action"}],columnDefs:[{className:"control",searchable:!1,orderable:!1,responsivePriority:2,targets:0,render:function(){return""}},{targets:-1,searchable:!1,orderable:!1,render:function(e,t,a,n){return'<div class="d-inline-block text-nowrap">\n                            <button class="btn btn-sm btn-icon" data-bs-toggle="modal" data-bs-target="#view-employee"><i class="bx bx-show-alt"></i></button>\n                            <button class="btn btn-sm btn-icon" data-bs-toggle="modal" data-bs-target="#update-employee"><i class="bx bx-edit"></i></button>\n                            <button class="btn btn-sm btn-icon delete-employee"><i class="bx bx-trash"></i></button>\n                        </div>'}}],order:[[1,"asc"]],data:l.message,buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle mx-3",text:'<i class="bx bx-export me-1"></i>Export',buttons:[{extend:"print",text:'<i class="bx bx-printer me-2" ></i>Print',className:"dropdown-item"},{extend:"excel",text:'<i class="bx bxs-file-export me-2"></i>Excel',className:"dropdown-item"},{extend:"pdf",text:'<i class="bx bxs-file-pdf me-2"></i>Pdf',className:"dropdown-item"}]},{text:'<i class="bx bx-plus me-0 me-sm-1"></i><span class="d-none d-sm-inline-block">Add New</span>',className:"add-new btn btn-primary",attr:{id:"showAddEForm"}}],responsive:{details:{display:$.fn.dataTable.Responsive.display.modal({header:function(e){return"Details of "+e.data().names}}),type:"column",renderer:function(e,t,a){return a=$.map(a,function(e,t){return""!==e.title?'<tr data-dt-row="'+e.rowIndex+'" data-dt-column="'+e.columnIndex+'"><td>'+e.title+":</td> <td>"+e.data+"</td></tr>":""}).join(""),!!a&&$('<table class="table"/><tbody />').append(a)}}},initComplete:function(){this.api().columns(3).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Position </option></select>').appendTo(".employee-position").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})}),this.api().columns(4).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Health Post </option></select>').appendTo(".employee-hp").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e+'">'+e+"</option>")})}),this.api().columns(5).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Department </option></select>').appendTo(".employee-department").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e.toLowerCase()+'" class="text-capitalize">'+e+"</option>")})}),this.api().columns(6).every(function(){var e=this,t=$('<select class="form-select text-capitalize"><option value=""> Select Status </option></select>').appendTo(".employee-status").on("change",function(){var t=$.fn.dataTable.util.escapeRegex($(this).val());e.search(t?"^"+t+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(e,a){t.append('<option value="'+e.toLowerCase()+'" class="text-capitalize">'+e+"</option>")})})}});g.find("tbody").on("click",".delete-employee",function(){confirm("Are you sure you want to delete this employee?")&&y.row($(this).parents("tr")).remove().draw()});let x=document.querySelector("#showAddEForm");x.onclick=function(e){e.preventDefault(),t()}});