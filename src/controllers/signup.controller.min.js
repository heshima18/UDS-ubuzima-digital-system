import query from"./query.controller";import errorMessage from"./response.message.controller";import id from"./randomInt.generator.controller";import generate2FAcode from"./2FA.code.generator.controller";import sendmail from"./2FA.sender.controller";import{checkEmail,checkHouseHolder,checkNID,checkPhone,checku_name}from"./credentials.verifier.controller";const signup=async(e,s)=>{try{let{username:r,password:a,Full_name:t,email:n,phone:o,assurances:i,dob:c,role:l,province:u,district:d,sector:g,cell:m,nid:_,gender:f,householder:h,fp_data:p}=e.body;if(h){let e=await checkHouseHolder(h);if(!e)return s.status(500).send({success:!1,message:errorMessage.is_error});if(!e.length)return s.send({success:!1,message:errorMessage._err_hH_404});h=e[0].id}else h=null;if(n){let e=await checkEmail(n,"patients");if(!e)return s.status(500).send({success:!1,message:errorMessage.is_error});if(e.length)return s.send({success:!1,message:errorMessage._err_email_avai})}else n=null;if(o){let e=await checkPhone(o,"patients");if(!e)return s.status(500).send({success:!1,message:errorMessage.is_error});if(e.length)return s.send({success:!1,message:errorMessage._err_phone_avai})}else o=null;if(_){let e=await checkNID(_,"patients");if(!e)return s.status(500).send({success:!1,message:errorMessage.is_error});if(e.length)return s.send({success:!1,message:errorMessage._err_NID_avai})}else _=null;let M=await checku_name(r,"patients");if(!M)return s.status(500).send({success:!1,message:errorMessage.is_error});if(M.length)return s.send({success:!1,message:errorMessage._err_uname_avai});let v=id(),w=await query("insert into patients(id,NID,email,phone,Full_name,username,password,DOB,resident_province,resident_district,resident_sector,resident_cell,status,assurances,gender,role,householder)values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",[v,_,n,o,t,r,a,c,u,d,g,m,"unverified",JSON.stringify(i),f,l,h]),y=generate2FAcode();if(!w)return void s.send({success:!1,message:errorMessage.is_error});await query("update patients set  FA = ? where id = ?",[y,v]);sendmail(n,{subject:"UDS your 2FA one time verification code",body:`${y}`},t,"2FA code");if(p){let e=await query("insert into fingerprints (id,user,data) values(?,?,?)",[id(),v,p]);e&&console.log("fp recorded")}s.send({success:!0,message:errorMessage.uc_message})}catch(e){console.log(e),s.send({success:!1,message:errorMessage.is_error})}};export default signup;