function calculateMissingHours(e){let s=e;const t=s.hour;if(t>=18){const e=24-t+8;return s=s.plus({hours:e}),s}if(t<8){const e=8-t;return s=s.plus({hours:e}),s}return s}import{DateTime}from"luxon";import query from"../controllers/query.controller";import errorMessage from"../controllers/response.message.controller";import authenticateToken from"../controllers/token.verifier.controller";export const CheckAppointmentTimer=async(e,s,t)=>{try{let{time:r,token:o,status:n}=e.body;if("declined"==n)return t();let i=authenticateToken(o);if(i=i.token.id,!i)return s.status(404).send({message:errorMessage._err_hcp_404,success:!1});let a=await query("select time from appointments where hc_provider = ? and status != ? and status != ? order by time desc limit 0,1",[i,"outdated","declined"]);if(!a)return s.status(500).send({message:errorMessage.is_error,success:!1});if(0==a.length)return void t();if([a]=a,a.time=new Date(a.time),r=new Date(r),r<=a.time)return s.send({message:errorMessage._err_hcp_unav,success:!1});if(r.getHours()>=18||r.getHours()<=8)return s.send({message:errorMessage._err_hcp_unav,success:!1});t()}catch(e){console.log(e),s.status(500).send({message:errorMessage.is_error,success:!1})}};export const getAppointmentETA=async(e,s)=>{try{const t=DateTime.now();let r=t.setZone("Africa/Kigali"),{time:o,token:n}=e.body;o||(o=r);let i=authenticateToken(n);if(i=i.token.id,!i)return s.status(404).send({message:errorMessage._err_hcp_404,success:!1});let a=await query("select time from appointments where hc_provider = ? and status != ? and status != ? and status != ? order by time desc limit 0,1",[i,"outdated","declined","completeted"]);return a?0==a.length?(o=r,o=calculateMissingHours(o),o=o.plus({minutes:45}),o=o.toFormat("yyyy-MM-dd HH:mm:ss"),s.send({success:!0,message:o.toString()})):([a]=a,a.time=DateTime.fromISO(a.time),r.toFormat("yyyy-MM-dd HH:mm:ss")<=a.time.toFormat("yyyy-MM-dd HH:mm:ss")?(a.time=a.time.plus({minutes:50}),a.time=calculateMissingHours(a.time),a.time=a.time.toFormat("yyyy-MM-dd HH:mm:ss"),s.send({message:a.time.toString(),success:!0,time:"dd"})):(o=o.plus({minutes:45}),o=o.toFormat("yyyy-MM-dd HH:mm:ss"),s.send({message:o.toString(),success:!0}))):s.status(500).send({message:errorMessage.is_error,success:!1})}catch(e){console.log(e),s.status(500).send({message:errorMessage.is_error,success:!1})}};